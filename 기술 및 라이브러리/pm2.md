## PM2

PM2는 Node.js 어플리케이션을 쉽게 관리할 수 있게 해주는 Process Manager이다. Node.js 어플리케이션을 cluster mode 로 실행시킨다거나, 메모리가 넘친다거나, 오류로 인해 프로세스가 종료되는 등의 상황에 직면했을 때 각각의 상황을 사용자가 모두 신경 써서 처리해줄 수도 있지만, 너무 복잡하고 신경 써야 할 일들이 많아진다.

**(1) 서비스를 제공하고 있는 도중 갑자기 서버가 중지되면 어떡하지?**
우리 프로젝트에서는 무중단운영을 하기위해 사용

**(2) Node.js는 싱글 스레드 기반인데 멀티 코어 혹은 하이퍼 스레딩을 사용하고 싶다면 어떻게 해야 하지?**

PM2의 cluster 모드는 Node.js의 cluster module을 이용해 기본적으로 싱글 스레드인 Node.js를 멀티 스레드로 구동시켜준다.

싱글 스레드의 경우 구동 중인 서버의 CPU 개수와 상관없이 1개만 사용할 수 있기에 서버의 성능을 제대로 끌어내지 못한다. 반면, 멀티 스레드는 최대 서버 CPU 수만큼(하이퍼스레딩을 지원한다면 x2) 프로세스를 생성해 최대 성능을 끌어낼 수 있다.

# **프로세스 재시작 과정**

프로세스 재시작 과정

![https://engineering.linecorp.com/wp-content/uploads/2019/05/image2019-5-9_16-29-13.png](https://engineering.linecorp.com/wp-content/uploads/2019/05/image2019-5-9_16-29-13.png)

프로세스 10개가 실행되고 있다고 가정해보겠습니다. 이런 상태에서 `pm2 reload`를 실행하면 PM2는 기존 ‘0’번 프로세스를 ‘_old_0’ 프로세스로 옮겨두고 새로운 0번 프로세스를 만듭니다. 새로운 0번 프로세스는 요청을 처리할 준비가 되면 마스터 프로세스에게 ‘ready’ 이벤트를 보내고, 마스터 프로세스는 더 이상 필요없어진 \_old_0 프로세스(기존 0번 프로세스)에게 ‘[SIGINT](https://en.wikipedia.org/wiki/Signal_(IPC)#SIGINT)‘ 시그널을 보내고 프로세스가 종료되기를 기다립니다. 만약 SIGINT 시그널을 보내고 난 후 일정 시간(1600ms)이 지났는데도 종료되지 않는다면, ‘[SIGKILL](<https://en.wikipedia.org/wiki/Signal_(IPC)#SIGKILL>)‘ 시그널을 보내 프로세스를 강제로 종료합니다. 0번 프로세스의 재시작은 이런 과정을 거쳐 완료되는데요. 이 과정을 총 프로세스 개수만큼 반복하면 모든 프로세스의 재시작이 완료됩니다.
